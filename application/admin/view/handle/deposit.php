<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!--头部文件-->
    <meta charset="UTF-8">
    <title>{$title}-{$data.pcsname}-{:Config('syc_webname')}</title>
    <meta name="author" content="www.sycit.cn, hyzwd@outlook.com"/>
    <link href="/favicon.ico" type="image/x-icon" rel="icon"/>
    <link href="/assets/plugins/bootstrap/css/bootstrap.css" rel="stylesheet" type="text/css" />
    <link href="/assets/admin/css/console1412.css" rel="stylesheet" type="text/css" />
    <link href="/assets/admin/css/sycit.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="/assets/plugins/jquery-2.2.4.min.js" ></script>
    <script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js" ></script>
    <script type="text/javascript" src="/assets/plugins/jquery-validation/js/jquery.validate.js"></script>
    <!--AJAX插件-->
    <script type="text/javascript" src="/assets/plugins/jquery.form.js" ></script>
    <!--弹窗插件-->
    <script type="text/javascript" src="/assets/plugins/toastr.js" ></script>
    <!-- bootstrap3-dialog -->
    <script type="text/javascript" src="/assets/plugins/b.dialog.js" ></script>
    <!-- layui -->
    <link rel="stylesheet" type="text/css" href="/assets/plugins/layui/css/layui.css">
    <script type="text/javascript" src="/assets/plugins/layui/layui.js"></script>

    <link href="/assets/plugins/fileinput/fileinput.css" rel="stylesheet" type="text/css" />
    <script src="/assets/plugins/fileinput/fileinput.js" type="text/javascript"></script>
    <!--全局JS-->
    <script type="text/javascript" src="/assets/admin/js/App.js" ></script>
    <script type="text/javascript" src="/assets/admin/scripts/sycit.js" ></script>
    <script type="text/javascript" src="/assets/admin/scripts/syc-order.js"></script>

</head>
<body>
<div class="console-container">
    <div class="row">
        <div class="col-lg-12">
            <div class="console-title console-title-border clearfix">
                <div class="col-md-6 pull-left order-title">
                    <h3><span>{$title}</span></h3>
                    <span class="text-explode">|</span>
                    <span class="head-title">{$data.pcsname}</span>
                </div>
                <div class="col-md-6 text-right">
                    <a href="javascript:window.close();" class="btn btn-default">
                        <span>关闭窗口</span></a>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="alert alert-tip marginTop15">
                <b class="text-danger">收款说明：</b>
                <p></p>
                <p>【收款比率】是自动四舍五入计算的，【收款日期】需要精算到秒，可以选择00秒，【备注信息】一定要填写。</p>
                <p>【需要注意】本页面有时间限制，也不可刷新页面，需要尽快操作完成。</p>
            </div>
        </div>
    </div>
    <!---->
    <div class="row">
        <div class="col-md-12">
            <div class="syc-table">
                <form class="form-horizontal" method="post" enctype="multipart/form-data" id="HandleDepositEditForm">
                    <input type="hidden" name="sycitcn" value="{$Request.token}" />
                    <input type="hidden" name="handle" value="deposit"/>
                    <input type="hidden" name="pid" value="{$data.pnumber}"/>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">企业名称</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control w300" value="{$data.pbname}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">客户名称</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control w300" value="{$data.pcsname}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">销售单号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control w300" value="{$data.pnumber}" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">订单确认</label>
                        <div class="col-sm-4">
                            <div class="radio">
                                <span class="label label-sm label-success">客户已确认订单</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-inline">
                            <label class="col-sm-2 control-label">实际总额</label>
                            <div class="col-sm-1">
                                <input type="text" class="form-control text-danger" id="sum_amount" value="{$sum_amount}" disabled>
                            </div>
                        </div>
                        <div class="form-inline">
                            <label class="col-sm-2 control-label">订单惠率</label>
                            <div class="col-sm-1">
                                <input type="text" class="form-control text-danger" id="youhuil" value="{$data.pyouhui}%" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-inline">
                            <label class="col-sm-2 control-label">惠率金额</label>
                            <div class="col-sm-1">
                                <input type="text" class="form-control text-danger" id="huilv_amount" value="{$data.pyouhui}" disabled>
                            </div>
                        </div>
                        <div class="form-inline">
                            <label class="col-sm-2 control-label text-danger">订单金额</label>
                            <div class="col-sm-2">
                                <input type="text" class="form-control text-danger" id="ddan_amount" value="{$data.pamount}" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-inline">
                            <label class="col-sm-2 control-label">收款比率</label>
                            <div class="col-sm-1">
                                <input type="text" class="form-control text-danger" id="djin_bfbi" disabled>
                            </div>
                        </div>
                        <div class="form-inline">
                            <label class="col-sm-2 control-label text-danger">收款金额</label>
                            <div class="col-sm-2">
                                <input type="text" class="form-control text-danger" name="djin_amount" id="djin_amount" value="">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-inline">
                            <label class="col-sm-2 control-label text-danger">收款项目</label>
                            <div class="col-sm-1">
                                <select class="form-control w150" name="sort" id="sort">
                                    <option value="1">订单订金</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-inline">
                            <label class="col-sm-2 control-label text-danger">收款日期</label>
                            <div class="col-sm-3">
                                <input type="text" class="form-control text-danger" name="shoukuan_time" id="shoukuan_time" value="" placeholder="年-月-日 时:分">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">上传图片</label>
                        <div class="col-sm-8">
                            <input id="input-4" name="pc_img" type="file" multiple class="file-loading form-control input-circle-right">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">备注信息</label>
                        <div class="col-sm-5">
                            <textarea class="form-control" name="remark" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="form-group modal-footer">
                        <div class="col-md-offset-2 pull-left">
                            <button type="submit" class="btn btn-primary"> 确认保存 </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        //图片上传
        $("#input-4").fileinput({
            //uploadUrl: "/sycit.php/upload_img/index.html", //图片上传的地址
            allowedFileExtensions : ['jpg', 'png','gif'],//接收的文件后缀
            showUpload: false, //是否显示上传按钮
            showCaption: false,//是否显示标题
            showRemove: false,//是否显示删除
            //showRemove: false,//是否显示删除
            //预览图片的设置
            initialPreview: [
                "<img src='/uploads/noimage.png' class='file-preview-image' style='width:auto;height:100px;'>",
            ],
        });
        $("#sum_amount").val(formatMoney({$sum_amount})); // 小写金额 实际总额
        $("#huilv_amount").val(formatMoney({$youhuije})); // 小写金额 优惠金额
        $("#ddan_amount").val(formatMoney({$data.pamount})); // 小写金额 订单金额

        //计算订金百分比
        //绑定优惠输入并计算
        $('input[name="djin_amount"]').watch(function(val) {
            if (val>=0) {
                var lv = (val / '{$data.pamount}') * 100;
                $('input[id="djin_bfbi"]').val(lv.toFixed(2) + '%');
            } else {
                $('input[name="djin_amount"]').val('');
            }
        });

        //日期选择
        layui.use('laydate', function() {
            var laydate = layui.laydate;
            //时间选择器
            laydate.render({
                elem: '#shoukuan_time'
                ,type: 'datetime'
            });
        });

        //提交
        $("#HandleDepositEditForm").validate({
            //
            rules: {
                djin_amount: {
                    required: true,
                },
                shoukuan_time: {
                    required: true,
                },
                remark: {
                    required: true,
                },
                sort: {
                    required: true,
                },
            },

            focusInvalid: true,
            onkeyup: false,
            //errorElement: 'div',
            errorClass: "error",
            //sycError:false,
            // ,
            errorPlacement: function(error, element) {}, //设置验证消息不显示
            invalidHandler: function(){toastr.warning("没有填写完整");},
            submitHandler: function(form) {
                // 文件上传类 获取整个表单数据
                var formData = new FormData(form);
                //自定额外信息
                //formData.append("CustomField", "This is some extra data");
                $.ajax({
                    url: "{:Url('handle/deposit')}",
                    type: 'POST',
                    data: formData,
                    processData: false, // 告诉jQuery不要去处理发送的数据
                    contentType: false, // 告诉jQuery不要去设置Content-Type请求头
                    success: function (result) {
                        if (result.code == '1') {
                            toastr.success(result.msg+"...正在关闭")
                            window.setTimeout(function(){
                                window.close(); //关闭本窗口页面
                            }, 2000);
                        } else {
                            toastr.error(result.msg+"...正在关闭");
                            window.setTimeout(function(){
                                window.close(); //关闭本窗口页面
                            }, 2000);
                        }
                    },
                    error: function (result) {
                        alert(result);
                    }
                });
                return false; // 阻止表单自动提交事件
            },
        });
    });
</script>
</body>
</html>